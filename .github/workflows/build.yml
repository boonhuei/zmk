#name: Build ZMK firmware
#on: [push, pull_request, workflow_dispatch]

#jobs:
#  build:
#    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@v0.3
name: Build Corne v4 Firmware

on:
  push:
    branches: [main]  # Trigger for the main branch, adjust as needed
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      # 1Ô∏è‚É£ Checkout the official ZMK firmware repo
      - name: Checkout ZMK upstream (Official Repo)
        uses: actions/checkout@v3
        with:
          repository: zmkfirmware/zmk   # The official ZMK repo
          path: zmk-upstream            # Place it in zmk-upstream directory

      # 2Ô∏è‚É£ Debugging: List contents of zmk-upstream to verify repo structure
      - name: Debugging: Check for west.yml and List zmk-upstream contents
        run: |
          echo "Listing contents of zmk-upstream folder:"
          ls -l zmk-upstream
          echo "Checking for west.yml in zmk-upstream:"
          if [ ! -f zmk-upstream/west.yml ]; then
            echo "‚ùå west.yml missing! The repository was not checked out correctly."
            exit 1
          fi
          echo "‚úÖ west.yml found in zmk-upstream. Proceeding with build."

      # 3Ô∏è‚É£ Checkout your custom ZMK config repo for overlays
      - name: Checkout Config repo (Your Custom Configuration)
        uses: actions/checkout@v3
        with:
          repository: boonhuei/zmk      # Your forked repo for custom overlays
          path: zmk-config             # Place in zmk-config directory

      # 4Ô∏è‚É£ Setup Python 3 for the build process (ZMK requires Python)
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      # 5Ô∏è‚É£ Install build dependencies
      - name: Install build dependencies
        run: |
          echo "Updating system and installing required dependencies..."
          sudo apt update
          sudo apt install -y cmake ninja-build python3-pip git wget gcc-arm-none-eabi device-tree-compiler

      # 6Ô∏è‚É£ Install West (ZMK's workspace manager)
      - name: Install west (ZMK workspace manager)
        run: |
          echo "Installing west..."
          pip install --upgrade pip
          pip install west

      # 7Ô∏è‚É£ Initialize the ZMK workspace using west
      - name: Initialize ZMK workspace
        working-directory: zmk-upstream
        run: |
          echo "Initializing west workspace..."
          west init -l .
          west update
          west zephyr-export
          echo "Workspace initialized successfully."

      # 8Ô∏è‚É£ Debug: List ZMK workspace structure to verify files
      - name: List ZMK workspace structure
        working-directory: zmk-upstream
        run: |
          echo "Listing the workspace structure..."
          ls -l
          echo "Displaying the Zephyr folder contents..."
          ls -l zephyr

      # 9Ô∏è‚É£ Build Left Half (corne_left) firmware
      - name: Build Left Half (corne_left)
        working-directory: zmk-upstream
        run: |
          echo "Building Left Half..."
          rm -rf build_left
          west build -b nice_nano_v2 -s app -d build_left \
            -DZMK_CONFIG=../zmk-config \
            -DSHIELD="corne_left nice_view" \
            -DSNIPPET=studio-rpc-usb-uart
          echo "Left Half build completed."

      # üîü Verify Left UF2 exists and is built successfully
      - name: Verify Left UF2 File
        working-directory: zmk-upstream
        run: |
          echo "Checking if Left UF2 file exists..."
          if [ -f build_left/zephyr/zmk.uf2 ]; then
            echo "‚úÖ Left UF2 exists at build_left/zephyr/zmk.uf2"
          else
            echo "‚ùå Left UF2 missing! Check the build logs."
            exit 1
          fi

      # 1Ô∏è‚É£1Ô∏è‚É£ Build Right Half (corne_right) firmware
      - name: Build Right Half (corne_right)
        working-directory: zmk-upstream
        run: |
          echo "Building Right Half..."
          rm -rf build_right
          west build -b nice_nano_v2 -s app -d build_right \
            -DZMK_CONFIG=../zmk-config \
            -DSHIELD="corne_right nice_view" \
            -DSNIPPET=studio-rpc-usb-uart
          echo "Right Half build completed."

      # 1Ô∏è‚É£2Ô∏è‚É£ Verify Right UF2 exists and is built successfully
      - name: Verify Right UF2 File
        working-directory: zmk-upstream
        run: |
          echo "Checking if Right UF2 file exists..."
          if [ -f build_right/zephyr/zmk.uf2 ]; then
            echo "‚úÖ Right UF2 exists at build_right/zephyr/zmk.uf2"
          else
            echo "‚ùå Right UF2 missing! Check the build logs."
            exit 1
          fi

      # 1Ô∏è‚É£3Ô∏è‚É£ Upload Left UF2 as artifact
      - name: Upload Left UF2 artifact
        uses: actions/upload-artifact@v4
        with:
          name: corne_left_with_studio
          path: zmk-upstream/build_left/zephyr/zmk.uf2

      # 1Ô∏è‚É£4Ô∏è‚É£ Upload Right UF2 as artifact
      - name: Upload Right UF2 artifact
        uses: actions/upload-artifact@v4
        with:
          name: corne_right_with_studio
          path: zmk-upstream/build_right/zephyr/zmk.uf2

      # 1Ô∏è‚É£5Ô∏è‚É£ Final debug: Show content of uploaded files
      - name: Debug: Show contents of uploaded artifacts
        run: |
          echo "Listing contents of the uploaded files:"
          ls -l zmk-upstream/build_left/zephyr
          ls -l zmk-upstream/build_right/zephyr
          echo "Artifacts are ready to be uploaded as UF2 files."
